/*! yaMap 13-11-2013 */
"use strict";angular.module("yaMap",[]).constant("GEOMETRY_TYPES",{POINT:"Point",LINESTRING:"LineString",RECTANGLE:"Rectangle",POLYGON:"Polygon",CIRCLE:"Circle"}).value("yaMapSettings",{lang:"ru-RU",order:"longlat"}).factory("mapApiLoad",["yaMapSettings",function(a){var b=!1,c=[],d=function(){b=!0;for(var a;c.length;)a=c.splice(0,1),a[0]()},e="http://api-maps.yandex.ru/2.0/?load=package.full&lang="+(a.lang||"ru-RU")+"&coordorder="+(a.order||"longlat"),f=!1,g=function(a,b){if(!f){f=!0;var c=document.createElement("script");c.type="text/javascript",c.readyState?c.onreadystatechange=function(){("loaded"==c.readyState||"complete"==c.readyState)&&(c.onreadystatechange=null,f=!1,b())}:c.onload=function(){f=!1,b()},c.src=a,document.getElementsByTagName("head")[0].appendChild(c)}};return function(a){c.push(a),b?d():g(e,function(){ymaps.ready(function(){d()})})}}]).service("yaLayer",[function(){this.create=function(a){return new ymaps.Layer(a)}}]).service("yaMapType",[function(){this.create=function(a,b){return new ymaps.MapType(a,b)}}]).service("layerStorage",["mapApiLoad",function(a){this.get=function(b){if(this._storage)b(this._storage);else{var c=this;a(function(){c._storage=ymaps.layer.storage,b(c._storage)})}}}]).service("mapTypeStorage",["mapApiLoad",function(a){this.get=function(b){if(this._storage)b(this._storage);else{var c=this;a(function(){c._storage=ymaps.mapType.storage,b(c._storage)})}}}]).service("yaSubscriber",function(){var a=/^yaEvent([A-Z]{1}[a-z]+)([A-Z]{1}[a-z]+)?$/;this.subscribe=function(b,c,d,e){var f=a.exec(d),g=(f[2]||f[1]).toLowerCase(),h=f[2]?f[1]:void 0;"geoobjects"===h&&(h="geoObjects"),e[d]=function(a){return c(e.$parent||e,a)};var i=h?b[h].events:b.events;i.add(g,function(a){setTimeout(function(){e.$apply(function(){e[d]({$event:a})})})})}}).service("templateLayoutFactory",[function(){this._cache={},this.get=function(a){return this._cache[a]},this.create=function(a,b,c){this._cache[a]||(this._cache[a]=ymaps.templateLayoutFactory.createClass(b,c))}}]).directive("yaTemplateLayout",["templateLayoutFactory",function(a){return{restrict:"E",priority:1001,scope:{overrides:"=yaOverrides"},compile:function(b){var c=b.html();return b.html(""),function(b,d,e){if(!e.yaKey)throw new Error('not require attribute "key"');var f=e.yaKey;a.create(f,c,b.overrides)}}}}]).controller("YaMapCtrl",["$scope","mapApiLoad",function(a,b){var c=this;b(function(){c.addGeoObjects=function(b){a.map.geoObjects.add(b)},c.removeGeoObjects=function(b){a.map.geoObjects.remove(b)},c.addControl=function(b,c){a.map.controls.add(b,c)},c.getMap=function(){return a.map},c.addImageLayer=function(b,c){var d=new ymaps.Layer(b,c);a.map.layers.add(d)},c.addHotspotLayer=function(b,c,d){var e=new ymaps.hotspot.ObjectSource(b,c),f=new ymaps.hotspot.Layer(e,d);a.map.layers.add(f)},c.addToolbar=function(b){a.map.controls.add(b)}})}]).directive("yaMap",["$compile","mapApiLoad","yaMapSettings","$window","yaSubscriber","$parse",function(a,b,c,d,e,f){return{restrict:"E",scope:{yaCenter:"@",yaType:"@",yaBeforeInit:"&",yaAfterInit:"&"},compile:function(g){var h=g.contents();return g.html(""),function(g,i,j){for(var k,l=function(a){try{return g.$eval(a)}catch(b){return a}},m=l(j.yaCenter),n=Number(j.yaZoom),o=j.yaBehaviors?j.yaBehaviors.split(" "):["default"],p=[],q=[],r=0,s=o.length;s>r;r++)k=o[r],"-"===k[0]?p.push(k.substring(1)):q.push(k);n=0>n?0:n,n=n>23?23:n;var t=function(a){m?angular.isArray(m)?b(a):angular.isString(m)&&b(function(){ymaps.geocode(m,{results:1}).then(function(b){var c=b.geoObjects.get(0);m=c.geometry.getCoordinates(),a&&a()},function(a){d.alert(a.message)})}):b(function(){m="longlat"===c.order?[ymaps.geolocation.longitude,ymaps.geolocation.latitude]:[ymaps.geolocation.latitude,ymaps.geolocation.longitude],a&&a()})},u=function(){g.yaBeforeInit();var b=j.yaOptions?g.$eval(j.yaOptions):void 0;b&&b.projection&&(b.projection=new ymaps.projection[b.projection.type](b.projection.bounds)),g.map=new ymaps.Map(i[0],{center:m,zoom:n,type:j.yaType||"yandex#map",behaviors:q},b),g.map.behaviors.disable(p);for(var c in j)if(0===c.indexOf("yaEvent")){var d=f(j[c]);e.subscribe(g.map,d,c,g)}g.yaAfterInit({$target:g.map}),i.append(h),setTimeout(function(){g.$apply(function(){a(h)(g.$parent)})})};g.$watch("yaCenter",function(a){m=l(a),t(function(){g.map.setCenter(m)})}),g.$watch("yaType",function(a){a&&g.map.setType(a)}),g.$on("$destroy",function(){g.map&&g.map.destroy()}),t(u)}},controller:"YaMapCtrl"}}]).controller("MapToolbarCtrl",["$scope",function(a){this.add=function(b){a.toolbar.add(b)}}]).directive("yaToolbar",["$compile","$parse","yaSubscriber",function(a,b,c){return{require:"^yaMap",restrict:"E",scope:{yaAfterInit:"&"},compile:function(d){var e=d.contents();return d.html(""),function(d,f,g,h){if(!g.yaName)throw new Error('not pass attribute "name"');var i=g.yaOptions?d.$eval(g.yaOptions):void 0,j=g.yaParams?d.$eval(g.yaParams):void 0,k=g.yaName[0].toUpperCase()+g.yaName.substring(1);d.toolbar=new ymaps.control[k](j);for(var l in g)if(0===l.indexOf("yaEvent")){var m=b(g[l]);c.subscribe(d.toolbar,m,l,d)}h.addControl(d.toolbar,i),d.yaAfterInit({$target:d.toolbar}),f.append(e),a(e)(d.$parent)}},controller:"MapToolbarCtrl"}}]).directive("yaControl",["yaSubscriber","templateLayoutFactory","$parse",function(a,b,c){return{restrict:"E",require:"^yaToolbar",scope:{yaAfterInit:"&"},link:function(d,e,f,g){var h=f.yaType[0].toUpperCase()+f.yaType.substring(1),i=function(a){try{return d.$eval(a)}catch(b){return a}},j=i(f.yaParams),k=f.yaOptions?d.$eval(f.yaOptions):void 0;k&&k.layout&&(k.layout=b.get(k.layout)),k&&k.itemLayout&&(k.itemLayout=b.get(k.itemLayout));var l,m=["SearchControl","SmallZoomControl","ScaleLine","ZoomControl"];if(m.indexOf(h)>-1)l=new ymaps.control[h](k);else{if(j&&j.items){for(var n,o=[],p=0,q=j.items.length;q>p;p++)n=j.items[p],o.push(new ymaps.control.ListBoxItem(n));j.items=o}l=new ymaps.control[h](j,k)}for(var r in f)if(0===r.indexOf("yaEvent")){var s=c(f[r]);a.subscribe(l,s,r,d)}g.add(l),d.yaAfterInit({$target:l})}}}]).controller("CollectionCtrl",["$scope",function(a){this.addGeoObjects=function(b){a.collection.add(b)},this.removeGeoObjects=function(b){a.collection.remove(b)}}]).directive("yaCollection",["$compile","yaMapSettings","$timeout","yaSubscriber","$parse",function(a,b,c,d,e){return{require:"^yaMap",restrict:"E",scope:{yaAfterInit:"&"},compile:function(b){var f=b.contents();return b.html(""),function(b,g,h,i){var j=h.yaOptions?b.$eval(h.yaOptions):{},k=angular.isDefined(h.showAll)&&"false"!=h.showAll;if(k){var l,m=i.getMap(),n=function(){l&&c.cancel(l),l=c(function(){m.geoObjects.events.remove("add",n);var a=m.geoObjects.getBounds();a&&m.setBounds(a)},300)};m.geoObjects.events.add("add",n)}b.collection=new ymaps.GeoObjectCollection({},j);for(var o in h)if(0===o.indexOf("yaEvent")){var p=e(h[o]);d.subscribe(b.collection,p,o,b)}i.addGeoObjects(b.collection),b.yaAfterInit({$target:b.collection}),b.$on("$destroy",function(){b.collection&&i.removeGeoObjects(b.collection)}),g.append(f),a(f)(b.$parent)}},controller:"CollectionCtrl"}}]).directive("yaCluster",["yaMapSettings","yaSubscriber","$compile","templateLayoutFactory","$parse",function(a,b,c,d,e){return{require:"^yaMap",restrict:"E",scope:{yaAfterInit:"&"},compile:function(a){var f=a.contents();return a.html(""),function(a,g,h,i){var j=h.yaOptions?a.$eval(h.yaOptions):{};j&&j.clusterBalloonMainContentLayout&&(j.clusterBalloonMainContentLayout=d.get(j.clusterBalloonMainContentLayout)),j&&j.clusterBalloonSidebarItemLayout&&(j.clusterBalloonSidebarItemLayout=d.get(j.clusterBalloonSidebarItemLayout)),j&&j.clusterBalloonContentItemLayout&&(j.clusterBalloonContentItemLayout=d.get(j.clusterBalloonContentItemLayout)),j&&j.clusterBalloonAccordionItemContentLayout&&(j.clusterBalloonAccordionItemContentLayout=d.get(j.clusterBalloonAccordionItemContentLayout)),a.collection=new ymaps.Clusterer(j);for(var k in h)if(0===k.indexOf("yaEvent")){var l=e(h[k]);b.subscribe(a.collection,l,k,a)}i.addGeoObjects(a.collection),a.yaAfterInit({$target:a.collection}),a.$on("$destroy",function(){a.collection&&i.removeGeoObjects(a.collection)}),g.append(f),c(f)(a.$parent)}},controller:"CollectionCtrl"}}]).directive("yaGeoObject",["GEOMETRY_TYPES","yaSubscriber","templateLayoutFactory","$parse",function(a,b,c,d){return{restrict:"E",require:["^yaMap","?^yaGeoObjects","?^yaCluster"],scope:{yaSource:"=",yaShowBalloon:"=",yaAfterInit:"&"},link:function(e,f,g,h){var i,j=h[2]||h[1]||h[0],k=g.yaOptions?e.$eval(g.yaOptions):void 0;k&&k.balloonContentLayout&&(k.balloonContentLayout=c.get(k.balloonContentLayout));var l=function(a,c){i=new ymaps.GeoObject(a,c);for(var f in g)if(0===f.indexOf("yaEvent")){var h=d(g[f]);b.subscribe(i,h,f,e)}j.addGeoObjects(i),e.yaAfterInit({$target:i}),m(g.yaEdit),n(g.yaDraw),o(e.yaShowBalloon)};e.$watch("yaSource",function(b){if(b)if(i){i.geometry.setCoordinates(b.geometry.coordinates),i.geometry.getType()===a.CIRCLE&&i.geometry.setRadius(b.geometry.radius);var c=b.properties;for(var d in c)c.hasOwnProperty(d)&&i.properties.set(d,c[d])}else l(b,k);else i&&j.removeGeoObjects(i)},angular.equals);var m=function(a){angular.isDefined(a)&&"false"!==a?i&&i.editor.startEditing():angular.isDefined(a)&&i&&i.editor.stopEditing()},n=function(a){angular.isDefined(a)&&"false"!==a?i&&i.editor.startDrawing():angular.isDefined(a)&&i&&i.editor.stopDrawing()},o=function(a){a?i&&i.balloon.open():i&&i.balloon.close()};g.$observe("yaEdit",m),g.$observe("yaDraw",n),e.$watch("yaShowBalloon",o),e.$on("$destroy",function(){i&&j.removeGeoObjects(i)})}}}]).directive("yaHotspotLayer",[function(){return{restrict:"E",require:"^yaMap",link:function(a,b,c,d){if(!c.yaUrlTemplate)throw new Error('not exists required attribute "url-template"');if(!c.yaKeyTemplate)throw new Error('not exists required attribute "key-template"');var e=c.yaOptions?a.$eval(c.yaOptions):void 0;d.addHotspotLayer(c.yaUrlTemplate,c.yaKeyTemplate,e)}}}]).directive("yaImageLayer",[function(){return{restrict:"E",require:"^yaMap",link:function(a,b,c,d){if(!c.yaUrlTemplate)throw new Error('not exists required attribute "url-template"');var e=c.yaOptions?a.$eval(c.yaOptions):void 0;d.addImageLayer(c.yaUrlTemplate,e)}}}]);